<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEN TOES ACADEMY</title>
    <link href="https://fonts.googleapis.com/css2?family=Chewy&display=swap" rel="stylesheet">
    <style>
        /* 样式与你提供的一样，保留即可 */
        /* 省略样式部分，完全保留你原本的CSS */
    </style>
</head>
<body>
    <!-- HTML 页面结构完全保留你原本的 -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const homeScreen = document.getElementById('homeScreen');
            const loadingScreen = document.getElementById('loadingScreen');
            const cameraScreen = document.getElementById('cameraScreen');
            const previewScreen = document.getElementById('previewScreen');
            const startBtn = document.getElementById('startBtn');
            const captureBtn = document.getElementById('captureBtn');
            const retakeBtn = document.getElementById('retakeBtn');
            const homeBtn = document.getElementById('homeBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const cameraFeed = document.getElementById('cameraFeed');
            const previewBg = document.getElementById('previewBg');
            const frameOverlay = document.getElementById('frameOverlay');
            const previewImage = document.getElementById('previewImage');
            const previewVideo = document.getElementById('previewVideo');
            const previewRetake = document.getElementById('previewRetake');
            const previewHome = document.getElementById('previewHome');
            const previewDownload = document.getElementById('previewDownload');
            const styleButtons = document.querySelectorAll('.style-button');
            const modeButtons = document.querySelectorAll('.mode-btn');
            const filterToggle = document.getElementById('filterToggle');
            const filterBar = document.getElementById('filterBar');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const timer = document.getElementById('timer');

            let currentStyle = 1;
            let currentFilter = null;
            let mediaStream = null;
            let mediaRecorder = null;
            let recordedChunks = [];
            let recordingTimer = null;
            let recordingTime = 10;

            let pressTimer = null;
            let pressStartTime = 0;

            startBtn.addEventListener('click', startApp);

            function startApp() {
                homeScreen.style.filter = 'blur(10px)';
                loadingScreen.style.opacity = '1';
                loadingScreen.style.pointerEvents = 'all';

                setTimeout(() => {
                    initCamera();
                }, 3000);
            }

            function initCamera() {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false })
                    .then(stream => {
                        mediaStream = stream;
                        cameraFeed.srcObject = stream;
                        loadingScreen.style.opacity = '0';
                        loadingScreen.style.pointerEvents = 'none';
                        cameraScreen.style.display = 'flex';
                    })
                    .catch(err => {
                        console.error('摄像头访问失败:', err);
                        loadingScreen.innerHTML = '<div class="loading-text">无法访问相机，请检查权限。<br><button onclick="location.reload()">返回重试</button></div>';
                    });
            }

            function updateStyle(style) {
                currentStyle = style;
                previewBg.src = `background${style}.png`;
                frameOverlay.src = `frame${style}.png`;
                styleButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.style == style) {
                        btn.classList.add('active');
                    }
                });
            }

            styleButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    updateStyle(btn.dataset.style);
                });
            });

            modeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.id === 'filterToggle') {
                        filterBar.classList.toggle('active');
                        return;
                    }
                    modeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    filterBar.classList.remove('active');
                });
            });

            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    if (btn.dataset.filter === currentFilter) {
                        currentFilter = null;
                        cameraFeed.style.filter = 'none';
                    } else {
                        btn.classList.add('active');
                        currentFilter = btn.dataset.filter;
                        switch (currentFilter) {
                            case 'warm': cameraFeed.style.filter = 'sepia(0.3) saturate(1.5) brightness(1.1)'; break;
                            case 'cool': cameraFeed.style.filter = 'hue-rotate(180deg) saturate(1.2) contrast(1.1)'; break;
                            case 'vintage': cameraFeed.style.filter = 'sepia(0.5) contrast(1.2) brightness(0.9)'; break;
                        }
                    }
                });
            });

            captureBtn.addEventListener('mousedown', startPress);
            captureBtn.addEventListener('touchstart', startPress);
            captureBtn.addEventListener('mouseup', endPress);
            captureBtn.addEventListener('touchend', endPress);

            function startPress(e) {
                e.preventDefault();
                pressStartTime = new Date().getTime();
                pressTimer = setTimeout(() => {
                    startVideoRecording();
                }, 500);
            }

            function endPress(e) {
                e.preventDefault();
                let pressDuration = new Date().getTime() - pressStartTime;
                clearTimeout(pressTimer);
                if (pressDuration < 500) {
                    takePhoto();
                } else {
                    stopVideoRecording();
                }
            }

            function takePhoto() {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = cameraFeed.videoWidth;
                canvas.height = cameraFeed.videoHeight;

                context.translate(canvas.width, 0);
                context.scale(-1, 1);
                context.filter = cameraFeed.style.filter;
                context.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);

                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = canvas.width;
                finalCanvas.height = canvas.height;
                const finalCtx = finalCanvas.getContext('2d');

                finalCtx.drawImage(previewBg, 0, 0, finalCanvas.width, finalCanvas.height);
                finalCtx.drawImage(canvas, 0, 0, finalCanvas.width, finalCanvas.height);

                const frameImg = new Image();
                frameImg.src = frameOverlay.src;
                frameImg.onload = function () {
                    finalCtx.drawImage(frameImg, 0, 0, finalCanvas.width, finalCanvas.height);
                    previewImage.src = finalCanvas.toDataURL('image/png');
                    cameraScreen.style.display = 'none';
                    previewScreen.style.display = 'flex';
                    previewImage.style.display = 'block';
                    previewVideo.style.display = 'none';
                };
            }

            function startVideoRecording() {
                captureBtn.classList.add('video-recording');
                timer.style.display = 'block';
                timer.textContent = `${recordingTime}s`;

                recordedChunks = [];
                mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'video/webm' });

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    previewVideo.src = url;
                };

                mediaRecorder.start();

                let timeLeft = recordingTime;
                recordingTimer = setInterval(() => {
                    timeLeft--;
                    timer.textContent = `${timeLeft}s`;
                    if (timeLeft <= 0) {
                        stopVideoRecording();
                    }
                }, 1000);
            }

            function stopVideoRecording() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                captureBtn.classList.remove('video-recording');
                clearInterval(recordingTimer);
                timer.style.display = 'none';

                setTimeout(() => {
                    cameraScreen.style.display = 'none';
                    previewScreen.style.display = 'flex';
                    previewVideo.style.display = 'block';
                    previewImage.style.display = 'none';
                }, 500);
            }

            retakeBtn.addEventListener('click', () => {
                previewScreen.style.display = 'none';
                cameraScreen.style.display = 'flex';
            });

            homeBtn.addEventListener('click', () => {
                stopMedia();
                cameraScreen.style.display = 'none';
                homeScreen.style.filter = 'none';
            });

            previewRetake.addEventListener('click', () => {
                previewScreen.style.display = 'none';
                cameraScreen.style.display = 'flex';
            });

            previewHome.addEventListener('click', () => {
                stopMedia();
                previewScreen.style.display = 'none';
                homeScreen.style.filter = 'none';
            });

            previewDownload.addEventListener('click', () => {
                if (previewImage.style.display === 'block') {
                    const link = document.createElement('a');
                    link.href = previewImage.src;
                    link.download = `ten-toes-${new Date().getTime()}.png`;
                    link.click();
                } else {
                    const link = document.createElement('a');
                    link.href = previewVideo.src;
                    link.download = `ten-toes-${new Date().getTime()}.webm`;
                    link.click();
                }
            });

            function stopMedia() {
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                }
            }

            updateStyle(1);
        });
    </script>
</body>
</html>
